<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - P2P Lifecycle Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">P2P Lifecycle Simulator</h1>
            <div class="space-x-4">
                <a href="/" class="hover:underline">Home</a>
                <a href="/static/po.html" class="hover:underline">Purchase Orders</a>
                <a href="/static/asn.html" class="hover:underline">ASN</a>
                <a href="/static/receipt.html" class="hover:underline">Goods Receipt</a>
                <a href="/static/invoice.html" class="hover:underline">Invoices</a>
                <a href="/static/match.html" class="hover:underline">3-Way Match</a>
                <a href="/static/exception.html" class="hover:underline">Exceptions</a>
                <a href="/static/dashboard.html" class="font-bold underline">Dashboard</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-6">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-gray-800">Dashboard Overview</h2>
            <button id="refreshBtn" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700 transition">
                Refresh Data
            </button>
        </div>

        <!-- Overview Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
            <!-- Purchase Orders -->
            <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-blue-500">
                <div class="text-sm text-gray-600 mb-1">Purchase Orders</div>
                <div id="totalPOs" class="text-3xl font-bold text-blue-600">0</div>
            </div>

            <!-- ASNs -->
            <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-purple-500">
                <div class="text-sm text-gray-600 mb-1">ASNs</div>
                <div id="totalASNs" class="text-3xl font-bold text-purple-600">0</div>
            </div>

            <!-- Receipts -->
            <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-green-500">
                <div class="text-sm text-gray-600 mb-1">Receipts</div>
                <div id="totalReceipts" class="text-3xl font-bold text-green-600">0</div>
            </div>

            <!-- Invoices -->
            <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-orange-500">
                <div class="text-sm text-gray-600 mb-1">Invoices</div>
                <div id="totalInvoices" class="text-3xl font-bold text-orange-600">0</div>
            </div>

            <!-- Matches -->
            <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-indigo-500">
                <div class="text-sm text-gray-600 mb-1">Matches</div>
                <div id="totalMatches" class="text-3xl font-bold text-indigo-600">0</div>
            </div>

            <!-- Exceptions -->
            <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-red-500">
                <div class="text-sm text-gray-600 mb-1">Exceptions</div>
                <div id="totalExceptions" class="text-3xl font-bold text-red-600">0</div>
            </div>
        </div>

        <!-- Status Breakdowns and Financial Summary -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- PO Status Breakdown -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-4 text-gray-800">PO Status</h3>
                <div id="poStatusBreakdown" class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Invoice Status Breakdown -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Invoice Status</h3>
                <div id="invoiceStatusBreakdown" class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Exception Status Breakdown -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Exception Status</h3>
                <div id="exceptionStatusBreakdown" class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Summary -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-md p-6 text-white">
                <div class="text-sm opacity-90 mb-2">Total PO Amount</div>
                <div id="totalPOAmount" class="text-3xl font-bold">$0.00</div>
            </div>

            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-md p-6 text-white">
                <div class="text-sm opacity-90 mb-2">Total Invoice Amount</div>
                <div id="totalInvoiceAmount" class="text-3xl font-bold">$0.00</div>
            </div>

            <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-md p-6 text-white">
                <div class="text-sm opacity-90 mb-2">Total Variance</div>
                <div id="totalVariance" class="text-3xl font-bold">$0.00</div>
            </div>
        </div>

        <!-- Exception Severity Breakdown -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Exception Severity Distribution</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="severityBreakdown">
                <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                    <span class="text-sm font-medium text-gray-700">Critical</span>
                    <span id="severityCritical" class="text-xl font-bold text-red-600">0</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-orange-50 rounded-lg">
                    <span class="text-sm font-medium text-gray-700">High</span>
                    <span id="severityHigh" class="text-xl font-bold text-orange-600">0</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                    <span class="text-sm font-medium text-gray-700">Medium</span>
                    <span id="severityMedium" class="text-xl font-bold text-yellow-600">0</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                    <span class="text-sm font-medium text-gray-700">Low</span>
                    <span id="severityLow" class="text-xl font-bold text-blue-600">0</span>
                </div>
            </div>
        </div>

        <!-- PO Lifecycle Viewer -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-bold mb-4 text-gray-800">PO Lifecycle Viewer</h3>

            <!-- PO Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Select Purchase Order
                </label>
                <div class="flex gap-3">
                    <select id="poSelect" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Select a PO --</option>
                    </select>
                    <button id="loadLifecycleBtn" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700 transition">
                        Load Lifecycle
                    </button>
                </div>
            </div>

            <!-- Lifecycle View -->
            <div id="lifecycleContainer" class="hidden">
                <!-- PO Summary -->
                <div class="bg-gradient-to-r from-blue-50 to-blue-100 border border-blue-200 rounded-lg p-4 mb-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">PO ID:</span>
                            <span id="lifecyclePOID" class="font-semibold ml-2">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Vendor:</span>
                            <span id="lifecycleVendor" class="font-semibold ml-2">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Amount:</span>
                            <span id="lifecycleAmount" class="font-semibold ml-2">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Status:</span>
                            <span id="lifecycleStatus" class="font-semibold ml-2">-</span>
                        </div>
                    </div>
                </div>

                <!-- Entity Counts -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-3 text-center">
                        <div class="text-xs text-gray-600 mb-1">ASNs</div>
                        <div id="lifecycleASNCount" class="text-2xl font-bold text-purple-600">0</div>
                    </div>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
                        <div class="text-xs text-gray-600 mb-1">Receipts</div>
                        <div id="lifecycleReceiptCount" class="text-2xl font-bold text-green-600">0</div>
                    </div>
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 text-center">
                        <div class="text-xs text-gray-600 mb-1">Invoices</div>
                        <div id="lifecycleInvoiceCount" class="text-2xl font-bold text-orange-600">0</div>
                    </div>
                    <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3 text-center">
                        <div class="text-xs text-gray-600 mb-1">Matches</div>
                        <div id="lifecycleMatchCount" class="text-2xl font-bold text-indigo-600">0</div>
                    </div>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-center">
                        <div class="text-xs text-gray-600 mb-1">Exceptions</div>
                        <div id="lifecycleExceptionCount" class="text-2xl font-bold text-red-600">0</div>
                    </div>
                </div>

                <!-- Timeline -->
                <div>
                    <h4 class="text-lg font-bold mb-3 text-gray-800">Timeline</h4>
                    <div id="timelineContainer" class="space-y-3">
                        <!-- Timeline items will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="lifecycleEmptyState" class="text-center py-12 text-gray-500">
                Select a Purchase Order to view its complete lifecycle
            </div>
        </div>
    </div>

    <!-- Include API client and utilities -->
    <script src="/static/js/api.js"></script>
    <script src="/static/js/utils.js"></script>

    <script>
        // ====================================================================
        // STATE
        // ====================================================================

        let dashboardStats = null;
        let availablePOs = [];

        // ====================================================================
        // INITIALIZATION
        // ====================================================================

        document.addEventListener('DOMContentLoaded', async () => {
            await loadDashboard();
            await loadPOList();

            document.getElementById('refreshBtn').addEventListener('click', loadDashboard);
            document.getElementById('loadLifecycleBtn').addEventListener('click', loadLifecycle);
        });

        // ====================================================================
        // LOAD DASHBOARD STATISTICS
        // ====================================================================

        async function loadDashboard() {
            try {
                dashboardStats = await getDashboardStats();
                displayDashboardStats();
            } catch (error) {
                console.error('Failed to load dashboard statistics:', error);
                alert('Failed to load dashboard statistics');
            }
        }

        function displayDashboardStats() {
            if (!dashboardStats) return;

            // Overview counts
            document.getElementById('totalPOs').textContent = dashboardStats.total_pos;
            document.getElementById('totalASNs').textContent = dashboardStats.total_asns;
            document.getElementById('totalReceipts').textContent = dashboardStats.total_receipts;
            document.getElementById('totalInvoices').textContent = dashboardStats.total_invoices;
            document.getElementById('totalMatches').textContent = dashboardStats.total_matches;
            document.getElementById('totalExceptions').textContent = dashboardStats.total_exceptions;

            // Financial summary
            document.getElementById('totalPOAmount').textContent = `$${dashboardStats.total_po_amount.toFixed(2)}`;
            document.getElementById('totalInvoiceAmount').textContent = `$${dashboardStats.total_invoice_amount.toFixed(2)}`;
            document.getElementById('totalVariance').textContent = `$${Math.abs(dashboardStats.total_variance_amount).toFixed(2)}`;

            // PO status breakdown
            const poStatusHTML = Object.entries(dashboardStats.pos_by_status)
                .map(([status, count]) => {
                    const badge = getStatusBadge(status, 'po');
                    return `
                        <div class="flex justify-between items-center">
                            ${badge}
                            <span class="text-lg font-semibold text-gray-800">${count}</span>
                        </div>
                    `;
                }).join('');
            document.getElementById('poStatusBreakdown').innerHTML = poStatusHTML || '<span class="text-sm text-gray-500">No data</span>';

            // Invoice status breakdown
            const invoiceStatusHTML = Object.entries(dashboardStats.invoices_by_status)
                .map(([status, count]) => {
                    const badge = getStatusBadge(status, 'invoice');
                    return `
                        <div class="flex justify-between items-center">
                            ${badge}
                            <span class="text-lg font-semibold text-gray-800">${count}</span>
                        </div>
                    `;
                }).join('');
            document.getElementById('invoiceStatusBreakdown').innerHTML = invoiceStatusHTML || '<span class="text-sm text-gray-500">No data</span>';

            // Exception status breakdown
            const exceptionStatusHTML = Object.entries(dashboardStats.exceptions_by_status)
                .map(([status, count]) => {
                    const badge = getStatusBadge(status, 'exception');
                    return `
                        <div class="flex justify-between items-center">
                            ${badge}
                            <span class="text-lg font-semibold text-gray-800">${count}</span>
                        </div>
                    `;
                }).join('');
            document.getElementById('exceptionStatusBreakdown').innerHTML = exceptionStatusHTML || '<span class="text-sm text-gray-500">No data</span>';

            // Exception severity breakdown
            document.getElementById('severityCritical').textContent = dashboardStats.exceptions_by_severity.critical || 0;
            document.getElementById('severityHigh').textContent = dashboardStats.exceptions_by_severity.high || 0;
            document.getElementById('severityMedium').textContent = dashboardStats.exceptions_by_severity.medium || 0;
            document.getElementById('severityLow').textContent = dashboardStats.exceptions_by_severity.low || 0;
        }

        // ====================================================================
        // LOAD PO LIST
        // ====================================================================

        async function loadPOList() {
            try {
                availablePOs = await listPurchaseOrders();

                const select = document.getElementById('poSelect');
                select.innerHTML = '<option value="">-- Select a PO --</option>';

                availablePOs.forEach(po => {
                    const option = document.createElement('option');
                    option.value = po.po_id;
                    option.textContent = `${po.po_id} - ${po.vendor_name} ($${po.total_amount.toFixed(2)})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load PO list:', error);
            }
        }

        // ====================================================================
        // LOAD PO LIFECYCLE
        // ====================================================================

        async function loadLifecycle() {
            const poId = document.getElementById('poSelect').value;
            if (!poId) {
                alert('Please select a Purchase Order');
                return;
            }

            try {
                const lifecycle = await getPOLifecycle(poId);
                displayLifecycle(lifecycle);
            } catch (error) {
                console.error('Failed to load PO lifecycle:', error);
                alert('Failed to load PO lifecycle');
            }
        }

        function displayLifecycle(lifecycle) {
            // Show lifecycle container, hide empty state
            document.getElementById('lifecycleContainer').classList.remove('hidden');
            document.getElementById('lifecycleEmptyState').classList.add('hidden');

            // PO Summary
            document.getElementById('lifecyclePOID').textContent = lifecycle.po_id;
            document.getElementById('lifecycleVendor').textContent = lifecycle.vendor_name;
            document.getElementById('lifecycleAmount').textContent = `$${lifecycle.total_amount.toFixed(2)}`;
            document.getElementById('lifecycleStatus').textContent = lifecycle.status.replace('_', ' ').toUpperCase();

            // Entity counts
            document.getElementById('lifecycleASNCount').textContent = lifecycle.asns.length;
            document.getElementById('lifecycleReceiptCount').textContent = lifecycle.receipts.length;
            document.getElementById('lifecycleInvoiceCount').textContent = lifecycle.invoices.length;
            document.getElementById('lifecycleMatchCount').textContent = lifecycle.matches.length;
            document.getElementById('lifecycleExceptionCount').textContent = lifecycle.exceptions.length;

            // Timeline
            const timelineHTML = lifecycle.timeline.map(step => createTimelineStep(step)).join('');
            document.getElementById('timelineContainer').innerHTML = timelineHTML;
        }

        function createTimelineStep(step) {
            const iconMap = {
                'po': 'üìù',
                'asn': 'üì¶',
                'receipt': '‚úÖ',
                'invoice': 'üíµ',
                'match': 'üîç',
                'exception': '‚ö†Ô∏è'
            };

            const colorMap = {
                'po': 'blue',
                'asn': 'purple',
                'receipt': 'green',
                'invoice': 'orange',
                'match': 'indigo',
                'exception': 'red'
            };

            const icon = iconMap[step.step_type] || 'üìÑ';
            const color = colorMap[step.step_type] || 'gray';

            return `
                <div class="flex items-start gap-3 p-3 border-l-4 border-${color}-500 bg-${color}-50 rounded-lg">
                    <div class="text-2xl">${icon}</div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="font-semibold text-gray-800">${step.step_type.toUpperCase()}</span>
                                <span class="text-gray-600 ml-2">${step.step_id}</span>
                            </div>
                            <span class="text-xs text-gray-500">${new Date(step.step_date).toLocaleString()}</span>
                        </div>
                        ${step.status ? `<div class="mt-1 text-sm text-gray-600">Status: <span class="font-medium">${step.status}</span></div>` : ''}
                        ${Object.keys(step.details).length > 0 ? `
                            <div class="mt-1 text-sm text-gray-600">
                                ${Object.entries(step.details).map(([key, value]) => `${key}: ${value}`).join(', ')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // ====================================================================
        // UTILITY FUNCTIONS
        // ====================================================================

        function getStatusBadge(status, type) {
            const statusFormatted = status.replace('_', ' ').toUpperCase();

            if (type === 'po') {
                const colors = {
                    'open': 'blue',
                    'partially_received': 'yellow',
                    'received': 'green',
                    'closed': 'gray'
                };
                const color = colors[status] || 'gray';
                return `<span class="text-sm font-medium text-${color}-800">${statusFormatted}</span>`;
            }

            if (type === 'invoice') {
                const colors = {
                    'pending': 'yellow',
                    'matched': 'green',
                    'blocked': 'red'
                };
                const color = colors[status] || 'gray';
                return `<span class="text-sm font-medium text-${color}-800">${statusFormatted}</span>`;
            }

            if (type === 'exception') {
                const colors = {
                    'open': 'red',
                    'in_review': 'yellow',
                    'resolved': 'green',
                    'closed': 'gray'
                };
                const color = colors[status] || 'gray';
                return `<span class="text-sm font-medium text-${color}-800">${statusFormatted}</span>`;
            }

            return `<span class="text-sm font-medium text-gray-800">${statusFormatted}</span>`;
        }
    </script>
</body>
</html>
